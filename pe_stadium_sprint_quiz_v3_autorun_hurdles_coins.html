<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PE ìŠ¤í…Œì´ë””ì›€ ìŠ¤í”„ë¦°íŠ¸ í€´ì¦ˆ (ìë™ ë‹¬ë¦¬ê¸° + ìë™ ë‹¤ìŒë¬¸ì œ)</title>
  <style>
    :root {
      --bg:#070b14; --panel:#101a33;
      --text:#eef2ff; --muted:#a7b7e0; --line:rgba(255,255,255,.12);
      --accent:#7aa8ff; --good:#4fe08d; --bad:#ff6b6b;
      --coin:#ffd166;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
      background:
        radial-gradient(900px 520px at 15% -10%, rgba(122,168,255,.22), transparent 55%),
        radial-gradient(900px 520px at 95% 10%, rgba(79,224,141,.12), transparent 60%),
        linear-gradient(180deg, #050810 0%, var(--bg) 70%, #050810 100%);
      color:var(--text);
      overflow-x:hidden;
    }

    .view{display:none; max-width:1100px; margin:0 auto; padding:18px}
    .view.active{display:block}

    .card{
      background: rgba(16,26,51,.90);
      border:1px solid var(--line);
      border-radius: 20px;
      padding:16px;
      box-shadow: 0 16px 46px rgba(0,0,0,.42);
    }
    .topTitle{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    h1{margin:0; font-size:18px; letter-spacing:-0.2px}
    p{margin:8px 0 0 0; color:var(--muted); font-size:13px; line-height:1.45}
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(122,168,255,.45);
      background: rgba(122,168,255,.14);
      color: var(--accent);
      font-size:12px;
      white-space:nowrap;
    }
    label{display:block; margin:10px 0 6px; color:var(--muted); font-size:12.8px}
    input, select, button {
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(9,14,26,.92);
      color: var(--text);
      font-size:14px;
      outline:none;
    }
    button{cursor:pointer}
    button.primary{background: rgba(122,168,255,.18); border-color: rgba(122,168,255,.55)}
    button.secondary{background: rgba(255,255,255,.06); border-color: var(--line)}
    button.danger{background: rgba(255,107,107,.14); border-color: rgba(255,107,107,.35)}

    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row > *{flex:1; min-width:240px}
    .btnRow{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    .btnRow button{flex:1; min-width:180px}
    .tiny{font-size:12px; color:var(--muted); line-height:1.35}

    .hud{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(16,26,51,.70);
      backdrop-filter: blur(8px);
    }
    .pill{
      padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      font-size:12.5px; color:var(--muted);
      white-space:nowrap;
    }
    .progressWrap{flex:1; min-width:220px}
    .progress{height:10px; background: rgba(255,255,255,.08); border:1px solid var(--line); border-radius:999px; overflow:hidden}
    .bar{height:100%; width:0%; background: rgba(122,168,255,.88); transition: width 280ms ease}

    .gameShell{
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap:14px;
      min-height: calc(100vh - 36px);
    }
    @media (max-width: 980px){ .gameShell{grid-template-columns:1fr;} }

    .trackCard{
      background: rgba(12,19,39,.92);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 12px;
      box-shadow: 0 16px 46px rgba(0,0,0,.34);
    }
    canvas{width:100%; height:340px; display:block; border-radius: 16px;}
    .hint{margin-top:10px; color:var(--muted); font-size:12px; line-height:1.4}

    .quizCard{
      background: rgba(16,26,51,.90);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 14px;
      box-shadow: 0 16px 46px rgba(0,0,0,.34);
    }
    .qTitle{font-size:16px; margin:0 0 6px 0; line-height:1.35}
    .qMeta{font-size:12.5px; color:var(--muted)}
    .choices{display:grid; gap:10px; margin-top:12px}
    .choiceBtn{
      text-align:left;
      background: rgba(9,14,26,.92);
      border: 1px solid var(--line);
      padding: 12px 12px;
      border-radius: 16px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease;
    }
    .choiceBtn:hover{transform: translateY(-1px); border-color: rgba(122,168,255,.60)}
    .choiceBtn:disabled{opacity:.72; cursor:not-allowed}

    .feedback{
      margin-top:12px;
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,0.04);
      display:none;
      line-height:1.45;
    }
    .feedback.good{display:block; border-color: rgba(79,224,141,0.40); background: rgba(79,224,141,0.08)}
    .feedback.bad{display:block; border-color: rgba(255,107,107,0.40); background: rgba(255,107,107,0.08)}

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      padding:10px 14px;
      background: rgba(9,14,26,.92);
      border:1px solid var(--line);
      border-radius: 999px;
      color: var(--text);
      font-size:13px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      opacity:0;
      pointer-events:none;
      transition: opacity 180ms ease, transform 180ms ease;
      z-index:50;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}
  </style>
</head>
<body>

<section class="view active" id="setupView">
  <div class="card">
    <div class="topTitle">
      <div>
        <h1>ğŸŸï¸ PE ìŠ¤í…Œì´ë””ì›€ ìŠ¤í”„ë¦°íŠ¸ í€´ì¦ˆ (ìì—°ìŠ¤ëŸ¬ìš´ ìë™ ë‹¬ë¦¬ê¸°)</h1>
        <p>
          âœ”ï¸ ì‹œì‘í•˜ë©´ ìºë¦­í„°ê°€ <b>ìë™ìœ¼ë¡œ ê³„ì† ë‹¬ë ¤ìš”</b>.<br>
          âœ… ì •ë‹µ â†’ <b>ì¶œë°œì„ ìœ¼ë¡œ ë¦¬ì…‹</b> í›„ ë‹¤ì‹œ ë‹¬ë¦¬ê¸° + <b>ë‹¤ìŒ ë¬¸ì œ ìë™</b><br>
          âŒ ì˜¤ë‹µ â†’ <b>ë„˜ì–´ì§</b> â†’ <b>ê·¸ ìë¦¬ì—ì„œ ë‹¤ì‹œ ë‹¬ë ¤ ê²°ìŠ¹ì„  í†µê³¼</b> + <b>ë‹¤ìŒ ë¬¸ì œ ìë™</b><br>
          ğŸ¯ ì˜ì—­ë³„ <b>5ë¬¸ì œ</b>
        </p>
      </div>
      <span class="badge">í˜•ì„±í‰ê°€ìš©</span>
    </div>

    <div class="row" style="margin-top:12px;">
      <div>
        <label>í•™ìƒ ì´ë¦„</label>
        <input id="studentName" placeholder="ì˜ˆ: ê¹€OO" />
        <div class="tiny">* ê²°ê³¼ ì €ì¥ì€ ì´ ì»´í“¨í„°(ë¸Œë¼ìš°ì € ë¡œì»¬)ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.</div>
      </div>
      <div>
        <label>ìŠ¤í…Œì´ì§€(ì˜ì—­) ì„ íƒ</label>
        <select id="domainSelect"></select>
        <div class="tiny" id="domainRange">-</div>
      </div>
    </div>

    <div class="btnRow">
      <button class="primary" id="startBtn">â–¶ï¸ ì‹œì‘</button>
      <button class="secondary" id="exportBtn">â¬‡ï¸ ê²°ê³¼ CSV</button>
      <button class="danger" id="clearBtn">ğŸ—‘ï¸ ê¸°ë¡ ì‚­ì œ</button>
    </div>

    <div class="card" style="margin-top:14px; background: rgba(12,19,39,.85);">
      <h2 style="margin:0 0 10px 0; font-size:14px;">ìµœê·¼ ê¸°ë¡ <span class="badge">ë¡œì»¬ ì €ì¥</span></h2>
      <div id="logBox" class="tiny" style="white-space:pre-wrap;">ì €ì¥ëœ ê¸°ë¡ì´ ì—†ì–´ìš”.</div>
    </div>
  </div>
</section>

<section class="view" id="gameView">
  <div class="hud">
    <button class="secondary" id="backBtn" style="width:auto; padding:9px 12px; border-radius:999px;">â¬…ï¸ ì„¤ì •</button>
    <div class="pill" id="hudDomain">ìŠ¤í…Œì´ì§€: -</div>
    <div class="pill" id="hudName">í•™ìƒ: -</div>
    <div class="progressWrap">
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>
    <div class="pill" id="hudScore">ì ìˆ˜: 0</div>
    <div class="pill" id="hudCount">ë¬¸í•­: 0/0</div>
  </div>

  <div class="gameShell">
    <div class="trackCard">
      <canvas id="track" width="900" height="340" aria-label="ë‹¬ë¦¬ê¸° íŠ¸ë™"></canvas>
      <div class="hint">
        ğŸª™ ì½”ì¸ì€ <b>ë³´ë„ˆìŠ¤</b>, í—ˆë“¤ì€ <b>ì—°ì¶œ</b>ì…ë‹ˆë‹¤.<br>
        * ë‹µì„ ê³ ë¥´ë©´ ì• ë‹ˆë©”ì´ì…˜ì´ ì§„í–‰ë˜ê³  <b>ìë™ìœ¼ë¡œ ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤</b>.
      </div>

      <div class="btnRow" style="margin-top:12px;">
        <button class="secondary" id="resetBtn">â†©ï¸ ë‹¤ì‹œí•˜ê¸°</button>
        <button class="secondary" id="saveBtn" disabled>âœ… ê²°ê³¼ ì €ì¥</button>
      </div>
    </div>

    <div class="quizCard">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <span class="badge" id="stageBadge">RUN</span>
        <span class="pill" id="coinsPill">ì½”ì¸: 0</span>
      </div>

      <p class="qTitle" id="qText">ì‹œì‘í•˜ë©´ ë¬¸ì œê°€ ë‚˜ì˜µë‹ˆë‹¤.</p>
      <div class="qMeta" id="qMeta">ì„±ì·¨ê¸°ì¤€: -</div>

      <div class="choices" id="choices"></div>
      <div class="feedback" id="feedback"></div>
    </div>
  </div>
</section>

<div class="toast" id="toast"></div>

<script type="application/ld+json">
{
  "@context": {
    "@vocab": "http://example.org/pe/game#",
    "schema": "https://schema.org/",
    "name": "schema:name",
    "description": "schema:description",
    "url": "schema:url",
    "keywords": "schema:keywords",
    "hasPart": {
      "@id": "schema:hasPart",
      "@type": "@id"
    },
    "learningResourceType": "schema:learningResourceType",
    "educationalLevel": "schema:educationalLevel",
    "inLanguage": "schema:inLanguage",
    "typicalAgeRange": "schema:typicalAgeRange",
    "question": "schema:question",
    "text": "schema:text",
    "answerExplanation": "schema:answerExplanation",
    "standardCode": "standardCode",
    "domainId": "domainId",
    "choices": "choices",
    "correctIndex": "correctIndex"
  },
  "@id": "game:TaekwondoBreakQuiz",
  "@type": "schema:LearningResource",
  "name": "íƒœê¶Œë„ ê²©íŒŒ í˜•ì„±í‰ê°€ ê²Œì„(ì²´ìœ¡ ì„±ì·¨ê¸°ì¤€ ê¸°ë°˜)",
  "description": "ë¬¸ì œê°€ ë‚˜ì˜¤ë©´ íƒœê¶Œë„ ì„ ìˆ˜ê°€ ê²©íŒŒ. ì •ë‹µ=íŒì ê²©íŒŒ(íš¨ê³¼ìŒ), ì˜¤ë‹µ=ì„ ìˆ˜ ì•„íŒŒí•˜ëŠ” ì—°ì¶œ.",
  "learningResourceType": "FormativeAssessmentGame",
  "educationalLevel": "ì¤‘í•™êµ(1~3í•™ë…„)",
  "inLanguage": "ko-KR",
  "typicalAgeRange": "13-15",
  "keywords": [
    "ì²´ìœ¡",
    "í˜•ì„±í‰ê°€",
    "ê²Œì„",
    "íƒœê¶Œë„",
    "ì„±ì·¨ê¸°ì¤€"
  ],
  "domains": [
    {
      "id": "health",
      "title": "ê±´ê°•",
      "range": "9ì²´01-01~9ì²´01-14",
      "keywords": [
        "ì²´ë ¥",
        "ìš´ë™ì²˜ë°©",
        "ì•ˆì „",
        "ê±´ê°•ê´€ë¦¬"
      ]
    },
    {
      "id": "action",
      "title": "ë™ì‘í˜• ìŠ¤í¬ì¸ ",
      "range": "9ì²´02-01~9ì²´02-03",
      "keywords": [
        "ê¸°ìˆ ",
        "ì›ë¦¬",
        "ì „ëµ",
        "ì•ˆì „"
      ]
    },
    {
      "id": "combat",
      "title": "íˆ¬ê¸°í˜• ìŠ¤í¬ì¸ ",
      "range": "9ì²´02-07~9ì²´02-09",
      "keywords": [
        "íƒœê¶Œë„",
        "ì•ˆì „",
        "ì˜ˆì ˆ"
      ]
    },
    {
      "id": "invasion",
      "title": "ì˜ì—­í˜• ìŠ¤í¬ì¸ ",
      "range": "9ì²´02-10~9ì²´02-12",
      "keywords": [
        "ë†êµ¬",
        "ì¶•êµ¬",
        "ì „ìˆ ",
        "ê³µê°„"
      ]
    },
    {
      "id": "field",
      "title": "í•„ë“œí˜• ìŠ¤í¬ì¸ ",
      "range": "9ì²´02-13~9ì²´02-15",
      "keywords": [
        "í•„ë“œ",
        "ê¸°ëŠ¥",
        "ìƒí™©íŒë‹¨"
      ]
    },
    {
      "id": "net",
      "title": "ë„¤íŠ¸í˜• ìŠ¤í¬ì¸ ",
      "range": "9ì²´02-16~9ì²´02-18",
      "keywords": [
        "ë°°ë“œë¯¼í„´",
        "ë°°êµ¬",
        "ë ë¦¬",
        "ì„œë¸Œ"
      ]
    },
    {
      "id": "life",
      "title": "ìƒí™œ/ìì—°í™˜ê²½í˜•+íƒœë„",
      "range": "9ì²´02-19~9ì²´02-27",
      "keywords": [
        "ìƒí™œìŠ¤í¬ì¸ ",
        "ì•¼ì™¸ì•ˆì „",
        "ìŠ¤í¬ì¸ ë§¨ì‹­",
        "í™˜ê²½"
      ]
    },
    {
      "id": "expr",
      "title": "ìŠ¤í¬ì¸  í‘œí˜„",
      "range": "9ì²´03-01~9ì²´03-10",
      "keywords": [
        "ë¦¬ë“¬",
        "ë™ì„ ",
        "ì°½ì‘",
        "ê°ìƒ"
      ]
    }
  ],
  "questions": [
    {
      "@id": "q:H1",
      "@type": "schema:Question",
      "domainId": "health",
      "standardCode": "9ì²´01-01",
      "question": {
        "@type": "schema:Text",
        "text": "ì²´ë ¥ ì¦ì§„ì„ ìœ„í•´ ê°€ì¥ ì¤‘ìš”í•œ ì›ë¦¬ëŠ” ë¬´ì—‡ì¼ê¹Œìš”?"
      },
      "choices": [
        "ë¬´ì¡°ê±´ ì˜¤ë˜ í•˜ê¸°",
        "ì ì§„ì ìœ¼ë¡œ ê°•ë„ë¥¼ ì˜¬ë¦¬ê¸°",
        "ì•„í”ˆ ë¶€ìœ„ë„ ì°¸ê³  í•˜ê¸°",
        "í•˜ë£¨ì— í•œ ë²ˆë§Œ í•˜ë©´ ì¶©ë¶„"
      ],
      "correctIndex": 1,
      "answerExplanation": "ì²´ë ¥ì€ ì ì§„ì ìœ¼ë¡œ(ì¡°ê¸ˆì”©) ë¶€ë‹´ì„ ëŠ˜ë¦´ ë•Œ ì•ˆì „í•˜ê²Œ í–¥ìƒë¼ìš”."
    },
    {
      "@id": "q:H2",
      "@type": "schema:Question",
      "domainId": "health",
      "standardCode": "9ì²´01-04",
      "question": {
        "@type": "schema:Text",
        "text": "ì²´ë ¥ì„ ì§„ë‹¨í•  ë•Œ ê°€ì¥ ì•ˆì „í•œ ë°©ë²•ì€?"
      },
      "choices": [
        "í˜¼ì ë¬´ë¦¬í•´ì„œ ìµœëŒ€ ê¸°ë¡ ë„ì „",
        "ì¤€ë¹„ìš´ë™ ì—†ì´ ë°”ë¡œ ì¸¡ì •",
        "ìê¸° ìˆ˜ì¤€ì— ë§ê²Œ ë‹¨ê³„ì ìœ¼ë¡œ ì¸¡ì •",
        "ì•„í”„ë©´ ì°¸ê³  ê³„ì†"
      ],
      "correctIndex": 2,
      "answerExplanation": "ì¸¡ì •ì€ ë‹¨ê³„ì ìœ¼ë¡œ, ë‚´ ìˆ˜ì¤€ì— ë§ê²Œ í•´ì•¼ ì•ˆì „í•´ìš”."
    },
    {
      "@id": "q:H3",
      "@type": "schema:Question",
      "domainId": "health",
      "standardCode": "9ì²´01-06",
      "question": {
        "@type": "schema:Text",
        "text": "ìš´ë™ ì²˜ë°© ê³„íšì„ ì„¸ìš¸ ë•Œ ê°€ì¥ ë¨¼ì € í™•ì¸í•  ê²ƒì€?"
      },
      "choices": [
        "ì¹œêµ¬ê°€ í•˜ëŠ” ìš´ë™",
        "ë‚´ ëª¸ ìƒíƒœì™€ ì²´ë ¥ ìˆ˜ì¤€",
        "ìœ í–‰í•˜ëŠ” ìš´ë™",
        "ë¹„ì‹¼ ìš´ë™ê¸°êµ¬"
      ],
      "correctIndex": 1,
      "answerExplanation": "ìš´ë™ ì²˜ë°©ì€ 'ë‚˜'ì˜ ì‹ ì²´ ì¡°ê±´ê³¼ ì²´ë ¥ ìˆ˜ì¤€ì´ ê¸°ì¤€ì´ì—ìš”."
    },
    {
      "@id": "q:A1",
      "@type": "schema:Question",
      "domainId": "action",
      "standardCode": "9ì²´02-01",
      "question": {
        "@type": "schema:Text",
        "text": "ë™ì‘í˜• ìŠ¤í¬ì¸ ì˜ íŠ¹ì§•ìœ¼ë¡œ ì•Œë§ì€ ê²ƒì€?"
      },
      "choices": [
        "ì ìˆ˜ë³´ë‹¤ í‘œí˜„ì´ ì¤‘ìš”",
        "ê¸°ìˆ  ë™ì‘ì˜ ì •í™•ì„±ì´ ì¤‘ìš”",
        "í™˜ê²½ ì¹œí™”ê°€ í•µì‹¬",
        "ê¸°ë¡(ì‹œê°„)ì´ ê°€ì¥ ì¤‘ìš”"
      ],
      "correctIndex": 1,
      "answerExplanation": "ë™ì‘í˜• ìŠ¤í¬ì¸ ëŠ” ê¸°ìˆ  ë™ì‘ì˜ ì •í™•í•œ ìˆ˜í–‰ì´ í•µì‹¬ì´ì—ìš”."
    },
    {
      "@id": "q:A2",
      "@type": "schema:Question",
      "domainId": "action",
      "standardCode": "9ì²´02-02",
      "question": {
        "@type": "schema:Text",
        "text": "ê¸°ìˆ ì„ ë” ì˜ í•˜ë ¤ë©´ ì–´ë–¤ ì—°ìŠµì´ ì¢‹ì„ê¹Œìš”?"
      },
      "choices": [
        "ë¬´ì¡°ê±´ ë¹ ë¥´ê²Œ ë°˜ë³µ",
        "ì›ë¦¬ë¥¼ ì´í•´í•˜ê³  ì •í™•íˆ ë°˜ë³µ",
        "ì‹¤ìˆ˜í•˜ë©´ ë°”ë¡œ í¬ê¸°",
        "ì¤€ë¹„ìš´ë™ ì—†ì´ ë°”ë¡œ ì‹¤ì „"
      ],
      "correctIndex": 1,
      "answerExplanation": "ì›ë¦¬ë¥¼ ì´í•´í•˜ê³  ì •í™•íˆ ë°˜ë³µí•˜ë©´ ì‹¤ë ¥ì´ ë¹ ë¥´ê²Œ ëŠ˜ì–´ìš”."
    },
    {
      "@id": "q:A3",
      "@type": "schema:Question",
      "domainId": "action",
      "standardCode": "9ì²´02-03",
      "question": {
        "@type": "schema:Text",
        "text": "ê²½ê¸° ì¤‘ ì•ˆì „ì„ ìœ„í•´ ê°€ì¥ ë¨¼ì € í•´ì•¼ í•  í–‰ë™ì€?"
      },
      "choices": [
        "ë¬´ë¦¬í•œ ëª¸ì‹¸ì›€",
        "ê·œì¹™ í™•ì¸ê³¼ ì•ˆì „ê±°ë¦¬ ìœ ì§€",
        "ë” ë¹¨ë¦¬ ë‹¬ë¦¬ê¸°",
        "ì¹œêµ¬ë¥¼ ë°€ì–´ ê³µê°„ ë§Œë“¤ê¸°"
      ],
      "correctIndex": 1,
      "answerExplanation": "ê·œì¹™ê³¼ ì•ˆì „ê±°ë¦¬, ì¶©ëŒ ì˜ˆë°©ì´ ê°€ì¥ ì¤‘ìš”í•´ìš”."
    },
    {
      "@id": "q:C1",
      "@type": "schema:Question",
      "domainId": "combat",
      "standardCode": "9ì²´02-07",
      "question": {
        "@type": "schema:Text",
        "text": "íˆ¬ê¸°í˜• ìŠ¤í¬ì¸ ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ íƒœë„ëŠ”?"
      },
      "choices": [
        "ìƒëŒ€ë¥¼ ì´ê¸°ê¸°ë§Œ í•˜ë©´ ë¨",
        "ìƒëŒ€ ì¡´ì¤‘ê³¼ ê·œì¹™ ì¤€ìˆ˜",
        "í˜ìœ¼ë¡œ ë°€ì–´ë¶™ì´ê¸°",
        "í° ì†Œë¦¬ë¡œ ìœ„í˜‘í•˜ê¸°"
      ],
      "correctIndex": 1,
      "answerExplanation": "íˆ¬ê¸°í˜• ìŠ¤í¬ì¸ ëŠ” ì˜ˆì ˆê³¼ ê·œì¹™, ìƒëŒ€ ì¡´ì¤‘ì´ ê¸°ë³¸ì´ì—ìš”."
    },
    {
      "@id": "q:C2",
      "@type": "schema:Question",
      "domainId": "combat",
      "standardCode": "9ì²´02-08",
      "question": {
        "@type": "schema:Text",
        "text": "ì•ˆì „í•œ ê¸°ë³¸ ìì„¸/ìŠ¤í…ì„ ì—°ìŠµí•˜ëŠ” ì´ìœ ë¡œ ë§ëŠ” ê²ƒì€?"
      },
      "choices": [
        "ë” ì„¸ê²Œ ë•Œë¦¬ê¸° ìœ„í•´",
        "ê· í˜•ê³¼ ê±°ë¦¬ ì¡°ì ˆë¡œ ë¶€ìƒ ì˜ˆë°©",
        "ìƒëŒ€ë¥¼ ë†€ë¼ê²Œ í•˜ë ¤ê³ ",
        "ë¹¨ë¦¬ ëë‚´ë ¤ê³ "
      ],
      "correctIndex": 1,
      "answerExplanation": "ê· í˜•ê³¼ ê±°ë¦¬ ì¡°ì ˆì´ ë¶€ìƒì„ ì¤„ì—¬ìš”."
    },
    {
      "@id": "q:C3",
      "@type": "schema:Question",
      "domainId": "combat",
      "standardCode": "9ì²´02-09",
      "question": {
        "@type": "schema:Text",
        "text": "ê²½ê¸° ì „ëµì„ í™œìš©í•  ë•Œ ê°€ì¥ ë°”ëŒì§í•œ ëª¨ìŠµì€?"
      },
      "choices": [
        "ë°˜ì¹™ì„ ì¨ì„œë¼ë„ ì´ê¹€",
        "ìƒëŒ€ì™€ ì•ˆì „ì„ ìš°ì„ í•˜ë©° ì „ëµ ì‚¬ìš©",
        "ë¬´ì¡°ê±´ ê³µê²©ë§Œ í•¨",
        "ìƒëŒ€ê°€ ë„˜ì–´ì§€ë©´ ê·¸ëŒ€ë¡œ ë‘ "
      ],
      "correctIndex": 1,
      "answerExplanation": "ì „ëµì€ ê·œì¹™ê³¼ ì•ˆì „ì„ ì§€í‚¤ë©´ì„œ ì‚¬ìš©í•´ì•¼ í•´ìš”."
    },
    {
      "@id": "q:I1",
      "@type": "schema:Question",
      "domainId": "invasion",
      "standardCode": "9ì²´02-10",
      "question": {
        "@type": "schema:Text",
        "text": "ì˜ì—­í˜• ìŠ¤í¬ì¸ (ì˜ˆ: ë†êµ¬/ì¶•êµ¬)ì—ì„œ ì¤‘ìš”í•œ ê²ƒì€?"
      },
      "choices": [
        "í•œ ìë¦¬ì—ì„œë§Œ í”Œë ˆì´",
        "ê³µê°„ì„ ë§Œë“¤ê³  ì´ë™í•˜ë©° í˜‘ë ¥",
        "ììœ ë¡­ê²Œ ë°˜ì¹™",
        "í˜¼ìë§Œ ê³µ ì¡ê¸°"
      ],
      "correctIndex": 1,
      "answerExplanation": "ê³µê°„ ë§Œë“¤ê¸°Â·ì´ë™Â·í˜‘ë ¥ì´ ì¤‘ìš”í•´ìš”."
    },
    {
      "@id": "q:I2",
      "@type": "schema:Question",
      "domainId": "invasion",
      "standardCode": "9ì²´02-11",
      "question": {
        "@type": "schema:Text",
        "text": "ê³µê²©ì—ì„œ 'ê³µê°„ ë§Œë“¤ê¸°'ì— ê°€ì¥ ë„ì›€ì´ ë˜ëŠ” í–‰ë™ì€?"
      },
      "choices": [
        "ê°™ì€ ê³³ì— ëª°ë¦¬ê¸°",
        "íŒ¨ìŠ¤ í›„ ë¹ˆ ê³µê°„ìœ¼ë¡œ ì´ë™",
        "ê³µ ì—†ì´ ì„œ ìˆê¸°",
        "ìƒëŒ€ë¥¼ ë°€ê¸°"
      ],
      "correctIndex": 1,
      "answerExplanation": "íŒ¨ìŠ¤ í›„ ì´ë™í•˜ë©´ íŒ¨ìŠ¤ ê¸¸ì´ ì—´ë ¤ìš”."
    },
    {
      "@id": "q:I3",
      "@type": "schema:Question",
      "domainId": "invasion",
      "standardCode": "9ì²´02-12",
      "question": {
        "@type": "schema:Text",
        "text": "ìˆ˜ë¹„ ì „í™˜ì´ ë¹ ë¥¸ íŒ€ì˜ ì¥ì ì€?"
      },
      "choices": [
        "ì²´ë ¥ì´ ì¤„ì–´ë“¦",
        "ì‹¤ì  ê°€ëŠ¥ì„±ì„ ì¤„ì„",
        "ë°˜ì¹™ì´ ëŠ˜ì–´ë‚¨",
        "ê³µì„ ì•ˆ ëºì–´ë„ ë¨"
      ],
      "correctIndex": 1,
      "answerExplanation": "ì „í™˜ì´ ë¹ ë¥´ë©´ ì‹¤ì ì„ ì¤„ì´ê³  ê¸°íšŒë¥¼ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”."
    },
    {
      "@id": "q:F1",
      "@type": "schema:Question",
      "domainId": "field",
      "standardCode": "9ì²´02-13",
      "question": {
        "@type": "schema:Text",
        "text": "í•„ë“œí˜• ìŠ¤í¬ì¸ ì˜ ì˜ˆë¡œ ì•Œë§ì€ ê²ƒì€?"
      },
      "choices": [
        "ë°°ë“œë¯¼í„´",
        "ì¶•êµ¬",
        "ì•¼êµ¬",
        "íƒœê¶Œë„"
      ],
      "correctIndex": 2,
      "answerExplanation": "ì•¼êµ¬ì²˜ëŸ¼ ë„“ì€ í•„ë“œì—ì„œ ì§„í–‰ë˜ëŠ” ì¢…ëª©ì´ í•´ë‹¹ë¼ìš”."
    },
    {
      "@id": "q:F2",
      "@type": "schema:Question",
      "domainId": "field",
      "standardCode": "9ì²´02-14",
      "question": {
        "@type": "schema:Text",
        "text": "í•„ë“œí˜• ìŠ¤í¬ì¸ ì—ì„œ ê¸°ë³¸ ê¸°ëŠ¥ì„ í–¥ìƒí•˜ë ¤ë©´?"
      },
      "choices": [
        "ê°ìœ¼ë¡œë§Œ í•˜ê¸°",
        "ê¸°ë³¸ìì„¸â†’ì •í™•ë„â†’ìƒí™© ì ìš© ìˆœì„œ",
        "ë¬´ì‘ì • ê°•í•˜ê²Œ",
        "ì—°ìŠµí•˜ì§€ ì•Šê¸°"
      ],
      "correctIndex": 1,
      "answerExplanation": "ê¸°ë³¸ìì„¸ì™€ ì •í™•ë„ë¥¼ ìŒ“ê³  ìƒí™©ì— ì ìš©í•´ìš”."
    },
    {
      "@id": "q:F3",
      "@type": "schema:Question",
      "domainId": "field",
      "standardCode": "9ì²´02-15",
      "question": {
        "@type": "schema:Text",
        "text": "ìƒí™©ì— ë§ëŠ” ì „ëµ í™œìš©ìœ¼ë¡œ ê°€ì¥ ì ì ˆí•œ ê²ƒì€?"
      },
      "choices": [
        "í•­ìƒ ê°™ì€ ì„ íƒ",
        "ìƒëŒ€ ìœ„ì¹˜ë¥¼ ë³´ê³  ì•ˆì „í•œ ì„ íƒ",
        "ìœ„í—˜í•´ë„ ë¬´ë¦¬",
        "ê·œì¹™ ë¬´ì‹œ"
      ],
      "correctIndex": 1,
      "answerExplanation": "ìƒí™© íŒë‹¨ + ì•ˆì „ + ê·œì¹™ì´ í•¨ê»˜ ê°€ì•¼ í•´ìš”."
    },
    {
      "@id": "q:N1",
      "@type": "schema:Question",
      "domainId": "net",
      "standardCode": "9ì²´02-16",
      "question": {
        "@type": "schema:Text",
        "text": "ë„¤íŠ¸í˜• ìŠ¤í¬ì¸ ì˜ íŠ¹ì§•ì€?"
      },
      "choices": [
        "ìƒëŒ€ ì§„ì˜ìœ¼ë¡œ ê³µì„ ë³´ë‚´ ë“ì ",
        "ìƒëŒ€ë¥¼ ë„˜ì–´ëœ¨ë ¤ ë“ì ",
        "ê¸°ë¡ ì¸¡ì •ì´ í•µì‹¬",
        "í‘œí˜„ì´ ê°€ì¥ ì¤‘ìš”"
      ],
      "correctIndex": 0,
      "answerExplanation": "ë„¤íŠ¸ ë„ˆë¨¸ë¡œ ê³µì„ ë³´ë‚´ë©° ë ë¦¬ì™€ ë“ì ì´ ì´ë£¨ì–´ì ¸ìš”."
    },
    {
      "@id": "q:N2",
      "@type": "schema:Question",
      "domainId": "net",
      "standardCode": "9ì²´02-17",
      "question": {
        "@type": "schema:Text",
        "text": "ë ë¦¬ë¥¼ ì˜¤ë˜ ì´ì–´ê°€ë ¤ë©´ ì¤‘ìš”í•œ ê²ƒì€?"
      },
      "choices": [
        "ë¬´ì¡°ê±´ ê°•í•˜ê²Œ ì¹˜ê¸°",
        "ì •í™•í•œ ë°©í–¥Â·ë†’ì´ ì¡°ì ˆ",
        "ëˆˆ ê°ê³  ì¹˜ê¸°",
        "ì¤€ë¹„ìš´ë™ ìƒëµ"
      ],
      "correctIndex": 1,
      "answerExplanation": "ê°•ì•½ ì¡°ì ˆê³¼ ì •í™•ë„ê°€ ë ë¦¬ë¥¼ ì‚´ë ¤ìš”."
    },
    {
      "@id": "q:N3",
      "@type": "schema:Question",
      "domainId": "net",
      "standardCode": "9ì²´02-18",
      "question": {
        "@type": "schema:Text",
        "text": "ì•ˆì „í•˜ê²Œ ê²½ê¸°í•˜ê¸° ìœ„í•œ í–‰ë™ì€?"
      },
      "choices": [
        "ì„œë¡œ ë¶€ë”ªí˜€ë„ ê³„ì†",
        "ë¼ì¸ê³¼ ì£¼ë³€ì„ í™•ì¸í•˜ë©° ì´ë™",
        "ë¼ì¼“ì„ íœ˜ë‘ë¥´ë©° ë›°ê¸°",
        "ìƒëŒ€ ê°€ê¹Œì´ ë¶™ê¸°"
      ],
      "correctIndex": 1,
      "answerExplanation": "ì£¼ë³€ í™•ì¸ê³¼ ì•ˆì „ê±°ë¦¬ê°€ ì¤‘ìš”í•´ìš”."
    },
    {
      "@id": "q:L1",
      "@type": "schema:Question",
      "domainId": "life",
      "standardCode": "9ì²´02-22",
      "question": {
        "@type": "schema:Text",
        "text": "ìì—°í™˜ê²½í˜• ìŠ¤í¬ì¸ (ì˜ˆ: ë“±ì‚°/ìº í•‘)ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€?"
      },
      "choices": [
        "ë©‹ìˆëŠ” ì‚¬ì§„",
        "ì•ˆì „ ì¥ë¹„Â·ë‚ ì”¨ í™•ì¸",
        "ë¹ ë¥¸ ì†ë„",
        "ë¬´ë¦¬í•œ ë„ì „"
      ],
      "correctIndex": 1,
      "answerExplanation": "ì•¼ì™¸ëŠ” ì•ˆì „ ì¤€ë¹„ê°€ 1ìˆœìœ„ì˜ˆìš”."
    },
    {
      "@id": "q:L2",
      "@type": "schema:Question",
      "domainId": "life",
      "standardCode": "9ì²´02-26",
      "question": {
        "@type": "schema:Text",
        "text": "ê²½ê¸° ì˜ˆì ˆê³¼ íŒ€ ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•´ ë°”ëŒì§í•œ ëª¨ìŠµì€?"
      },
      "choices": [
        "ì‹¤ìˆ˜í•œ ì¹œêµ¬ íƒ“í•˜ê¸°",
        "ì„œë¡œ ê²©ë ¤í•˜ë©° ì—­í•  ìˆ˜í–‰",
        "ë°˜ì¹™ì„ ìœ ë„",
        "ìƒëŒ€ ë¹„ë‚œ"
      ],
      "correctIndex": 1,
      "answerExplanation": "ì‹ ë¢°Â·í˜‘ë ¥Â·ì˜ˆì ˆì´ íŒ€ì„ ê°•í•˜ê²Œ í•´ìš”."
    },
    {
      "@id": "q:L3",
      "@type": "schema:Question",
      "domainId": "life",
      "standardCode": "9ì²´02-27",
      "question": {
        "@type": "schema:Text",
        "text": "ì§€ì†ê°€ëŠ¥í•œ ìŠ¤í¬ì¸  í™˜ê²½ì„ ìœ„í•´ í•  ìˆ˜ ìˆëŠ” í–‰ë™ì€?"
      },
      "choices": [
        "ì“°ë ˆê¸° ë²„ë¦¬ê¸°",
        "ì¥ë¹„ í•¨ë¶€ë¡œ ë‘ê¸°",
        "ì‚¬ìš©í•œ ê³³ ì •ë¦¬í•˜ê³  ì“°ë ˆê¸° ë˜ê°€ì ¸ì˜¤ê¸°",
        "ì‹œì„¤ í›¼ì†"
      ],
      "correctIndex": 2,
      "answerExplanation": "í™˜ê²½ì„ ì§€í‚¤ëŠ” íƒœë„ë„ ì²´ìœ¡ì˜ ì¤‘ìš”í•œ ê°€ì¹˜ì˜ˆìš”."
    },
    {
      "@id": "q:E1",
      "@type": "schema:Question",
      "domainId": "expr",
      "standardCode": "9ì²´03-01",
      "question": {
        "@type": "schema:Text",
        "text": "ìŠ¤í¬ì¸  í‘œí˜„ì˜ ëª©ì ì— ê°€ì¥ ê°€ê¹Œìš´ ê²ƒì€?"
      },
      "choices": [
        "ê¸°ë¡ì„ ì¬ê¸°",
        "ë™ì‘ì„ ì•„ë¦„ë‹µê²Œ í‘œí˜„í•˜ê³  ê°ìƒ",
        "ìƒëŒ€ë¥¼ ì´ê¸°ê¸°",
        "ë°˜ì¹™ì„ ì¤„ì´ê¸°"
      ],
      "correctIndex": 1,
      "answerExplanation": "í‘œí˜„ì€ ì›€ì§ì„ì„ ì‹¬ë¯¸ì ìœ¼ë¡œ êµ¬ì„±í•˜ê³  ê°ìƒí•˜ëŠ” í™œë™ì´ì—ìš”."
    },
    {
      "@id": "q:E2",
      "@type": "schema:Question",
      "domainId": "expr",
      "standardCode": "9ì²´03-03",
      "question": {
        "@type": "schema:Text",
        "text": "ì‘í’ˆì„ ì°½ì‘í•  ë•Œ ì¤‘ìš”í•œ ê²ƒì€?"
      },
      "choices": [
        "ì•„ë¬´ë ‡ê²Œë‚˜ í•˜ê¸°",
        "ë¦¬ë“¬Â·ë™ì„ Â·ê°•ì•½ì„ ê³ ë ¤",
        "ë™ì‘ì„ ìˆ¨ê¸°ê¸°",
        "ê°™ì€ ë™ì‘ë§Œ ë°˜ë³µ"
      ],
      "correctIndex": 1,
      "answerExplanation": "í‘œí˜„ ìš”ì†Œ(ë¦¬ë“¬Â·ê³µê°„Â·ê°•ì•½)ë¥¼ ê³ ë ¤í•˜ë©´ ì™„ì„±ë„ê°€ ì˜¬ë¼ê°€ìš”."
    },
    {
      "@id": "q:E3",
      "@type": "schema:Question",
      "domainId": "expr",
      "standardCode": "9ì²´03-10",
      "question": {
        "@type": "schema:Text",
        "text": "ë¹„í‰ì„ í•  ë•Œ ê°€ì¥ ë°”ëŒì§í•œ ë§í•˜ê¸°ëŠ”?"
      },
      "choices": [
        "ë¬´ì¡°ê±´ ê¹ì•„ë‚´ë¦¬ê¸°",
        "ì¢‹ì€ ì  1ê°œ + ê°œì„ ì  1ê°œë¥¼ ì¡´ì¤‘ í‘œí˜„",
        "ì›ƒê¸°ê¸°",
        "ì¹¨ë¬µ"
      ],
      "correctIndex": 1,
      "answerExplanation": "ê³µê°í•˜ê³  ì¡´ì¤‘í•˜ëŠ” í”¼ë“œë°±ì´ ì„±ì¥ì— ë„ì›€ë¼ìš”."
    }
  ]
}
</script>

<script>
/* ===== DATA ===== */
const rdf = JSON.parse(document.querySelector('script[type="application/ld+json"]').textContent);
const DOMAINS = rdf.domains;
const QUESTIONS = rdf.questions;

/* ===== Helpers ===== */
const $ = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));
const STORAGE_KEY = "pe_sprint_quiz_logs_v3_autorun";

function toast(msg) {
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 900);
}
function showView(id) {
  $$(".view").forEach(v => v.classList.remove("active"));
  $(id).classList.add("active");
  window.scrollTo(0,0);
}
function shuffle(arr) {
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--) {
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
let audioCtx;
function sfx(type="good") {
  try {
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    if(type==="good") {
      o.type="triangle";
      o.frequency.setValueAtTime(680, audioCtx.currentTime);
      o.frequency.exponentialRampToValueAtTime(1280, audioCtx.currentTime + 0.12);
      g.gain.setValueAtTime(0.18, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.18);
      o.start(); o.stop(audioCtx.currentTime + 0.19);
    } else {
      o.type="sawtooth";
      o.frequency.setValueAtTime(240, audioCtx.currentTime);
      o.frequency.exponentialRampToValueAtTime(140, audioCtx.currentTime + 0.12);
      g.gain.setValueAtTime(0.22, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.20);
      o.start(); o.stop(audioCtx.currentTime + 0.21);
    }
  } catch(e) {}
}

function loadLogs(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return [];
    const data = JSON.parse(raw);
    return Array.isArray(data) ? data : [];
  } catch(e) { return []; }
}
function saveLogs(logs){ localStorage.setItem(STORAGE_KEY, JSON.stringify(logs)); }
function nowStr(){
  const d = new Date();
  const p = (n)=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
}
function renderLogs(){
  const logs = loadLogs();
  if(!logs.length) {
    $("#logBox").textContent = "ì €ì¥ëœ ê¸°ë¡ì´ ì—†ì–´ìš”.";
    return;
  }
  const last = logs.slice(-10).reverse();
  $("#logBox").textContent = last.map(r =>
    `â€¢ ${r.time} | ${r.name} | ${r.domain} | ${r.score}/${r.totalQ} (ì½”ì¸ ${r.coins})`
  ).join("\n");
}
function exportCSV(){
  const logs = loadLogs();
  if(!logs.length) {
    alert("ë‚´ë³´ë‚¼ ê¸°ë¡ì´ ì—†ì–´ìš”!");
    return;
  }
  const headers = ["time","name","domain","range","totalQ","score","coins","rate"];
  const rows = logs.map(r => headers.map(h => `"${String(r[h] ?? "").replace(/"/g,'""')}"`).join(","));
  const csv = [headers.join(","), ...rows].join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `PE_Sprint_Quiz_Logs_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function clearLogs(){
  if(!confirm("ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ)")) return;
  localStorage.removeItem(STORAGE_KEY);
  renderLogs();
  toast("ê¸°ë¡ ì‚­ì œ");
}

/* ===== Quiz State ===== */
let currentDomainId = DOMAINS[0].id;
let pool = [];
let idx = 0;
let score = 0;
let coins = 0;
let answeredLock = false;

/* ===== Track State (AUTO RUN) ===== */
const canvas = $("#track");
const ctx = canvas.getContext("2d");
let W = canvas.width, H = canvas.height;

const state = {
  t: 0,
  camX: 0,
  startX: 140,
  finishX: 1700,     // ì¶©ë¶„íˆ ê¸¸ê²Œ
  runnerX: 140,
  runnerY: 226,
  baseV: 4.0,        // í‰ìƒì‹œ ìë™ ë‹¬ë¦¬ê¸° ì†ë„
  v: 4.0,
  phase: "cruise",   // cruise | stumble
  stumbleTimer: 0,
  wobble: 0,
  particles: [],
  message: "",

  // lap control
  awaitingAnswer: true,
  pendingAdvance: false,
  correctResetNext: false,

  // obstacles
  coins: [],
  hurdles: []
};

function roundRect(ctx,x,y,w,h,r){
  const rr = Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y,x+w,y+h,rr);
  ctx.arcTo(x+w,y+h,x,y+h,rr);
  ctx.arcTo(x,y+h,x,y,rr);
  ctx.arcTo(x,y,x+w,y,rr);
  ctx.closePath();
}

function spawnBurst(x,y,good=true){
  for(let i=0;i<16;i++) {
    const a = Math.random()*Math.PI*2;
    const sp = 1.4 + Math.random()*3.8;
    state.particles.push({
      x,y, vx: Math.cos(a)*sp, vy: Math.sin(a)*sp,
      life: 42 + Math.random()*18,
      good
    });
  }
}

function resetLapObjects(){
  // ì½”ì¸/í—ˆë“¤ ë°°ì¹˜(ë§¤ ë©ë§ˆë‹¤ ë¦¬ì…‹)
  state.coins = [];
  state.hurdles = [];
  for(let i=1;i<=7;i++) {
    state.hurdles.push({x: 260 + i*210, y: 240, hit:false});
  }
  for(let i=1;i<=7;i++) {
    state.coins.push({x: 200 + i*235, y: 170, taken:false});
  }
}

function resetToStart(){
  state.runnerX = state.startX;
  state.camX = 0;
  state.v = state.baseV;
  state.phase = "cruise";
  state.stumbleTimer = 0;
  state.wobble = 0;
  state.message = "";
  resetLapObjects();
}

function drawTrack(){
  ctx.clearRect(0,0,W,H);

  ctx.save();
  if(state.wobble>0) {
    const s = Math.sin(state.t*0.6)*state.wobble;
    ctx.translate(s, 0);
  }

  // sky
  const grad = ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0, "rgba(122,168,255,0.18)");
  grad.addColorStop(1, "rgba(0,0,0,0)");
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,W,H);

  // stands
  ctx.fillStyle = "rgba(255,255,255,0.05)";
  ctx.fillRect(0,20,W,70);
  ctx.fillRect(0,100,W,32);

  // lanes
  ctx.fillStyle = "rgba(255,255,255,0.04)";
  ctx.fillRect(0,160,W,170);

  ctx.strokeStyle = "rgba(255,255,255,0.10)";
  ctx.lineWidth = 2;
  for(let y=185; y<=305; y+=30) {
    ctx.beginPath();
    ctx.moveTo(0,y);
    ctx.lineTo(W,y);
    ctx.stroke();
  }

  ctx.save();
  ctx.translate(-state.camX, 0);

  // finish banner
  const fx = state.finishX;
  ctx.fillStyle = "rgba(255,255,255,0.08)";
  ctx.fillRect(fx, 140, 14, 200);
  ctx.fillStyle = "rgba(255,255,255,0.10)";
  ctx.fillRect(fx+14, 140, 14, 200);
  ctx.fillStyle = "rgba(122,168,255,0.22)";
  ctx.fillRect(fx-10, 120, 120, 34);
  ctx.fillStyle = "rgba(255,255,255,0.88)";
  ctx.font = "bold 14px system-ui";
  ctx.fillText("FINISH", fx+20, 143);

  // start marker
  ctx.fillStyle = "rgba(79,224,141,0.18)";
  ctx.fillRect(state.startX-12, 150, 6, 190);

  // coins
  for(const c of state.coins) {
    if(c.taken) continue;
    ctx.save();
    ctx.translate(c.x, c.y);
    ctx.rotate(Math.sin(state.t*0.08 + c.x*0.02)*0.18);
    ctx.fillStyle = "rgba(255,209,102,0.55)";
    ctx.beginPath(); ctx.ellipse(0,0,14,10,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = "rgba(255,255,255,0.35)";
    ctx.beginPath(); ctx.ellipse(-3,-2,6,4,0,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }

  // hurdles
  for(const h of state.hurdles) {
    ctx.save();
    ctx.translate(h.x,h.y);
    if(h.hit) {
      ctx.rotate(0.45);
      ctx.translate(0, 18);
    }
    ctx.strokeStyle = "rgba(255,255,255,0.28)";
    ctx.lineWidth = 6;
    ctx.beginPath(); ctx.moveTo(-14, 30); ctx.lineTo(-14, 0); ctx.stroke();
    ctx.beginPath(); ctx.moveTo( 14, 30); ctx.lineTo( 14, 0); ctx.stroke();
    ctx.strokeStyle = "rgba(255,107,107,0.55)";
    ctx.lineWidth = 8;
    ctx.beginPath(); ctx.moveTo(-22, 8); ctx.lineTo(22, 8); ctx.stroke();
    ctx.restore();
  }

  // runner
  const rx = state.runnerX, ry = state.runnerY;
  const moving = true;
  const legSwing = Math.sin(state.t*0.22) * (moving ? 10 : 4);
  const armSwing = Math.sin(state.t*0.22 + 1.4) * (moving ? 10 : 4);

  ctx.save();
  ctx.translate(rx, ry);

  // shadow
  ctx.fillStyle = "rgba(0,0,0,0.25)";
  ctx.beginPath(); ctx.ellipse(0, 56, 26, 8, 0, 0, Math.PI*2); ctx.fill();

  // body
  ctx.fillStyle = "rgba(255,255,255,0.92)";
  roundRect(ctx, -18, 10, 36, 34, 10); ctx.fill();
  // belt
  ctx.fillStyle = "rgba(0,0,0,0.75)";
  roundRect(ctx, -18, 28, 36, 8, 5); ctx.fill();

  // head
  ctx.fillStyle = "rgba(255,224,189,0.98)";
  ctx.beginPath(); ctx.arc(0, 0, 16, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = "rgba(22,24,32,0.92)";
  ctx.beginPath(); ctx.arc(0, -4, 16, Math.PI, Math.PI*2); ctx.fill();

  // arms
  ctx.strokeStyle = "rgba(255,255,255,0.92)";
  ctx.lineWidth = 8;
  ctx.lineCap = "round";
  ctx.beginPath(); ctx.moveTo(-10, 18); ctx.lineTo(-24, 30 + armSwing*0.08); ctx.stroke();
  ctx.beginPath(); ctx.moveTo( 10, 18); ctx.lineTo( 26, 26 - armSwing*0.08); ctx.stroke();

  // legs
  ctx.strokeStyle = "rgba(255,255,255,0.92)";
  ctx.lineWidth = 10;
  ctx.beginPath(); ctx.moveTo(-8, 44); ctx.lineTo(-18, 66 + legSwing*0.10); ctx.stroke();
  ctx.beginPath(); ctx.moveTo( 8, 44); ctx.lineTo( 20, 66 - legSwing*0.10); ctx.stroke();

  // stumble í‘œì‹œ
  if(state.phase==="stumble") {
    ctx.strokeStyle = "rgba(255,107,107,0.40)";
    ctx.lineWidth = 6;
    ctx.beginPath(); ctx.moveTo(-40, 30); ctx.lineTo(-18, 30); ctx.stroke();
  }

  ctx.restore();

  ctx.restore(); // world

  // particles (screen space)
  for(const p of state.particles) {
    ctx.fillStyle = p.good ? "rgba(79,224,141,0.75)" : "rgba(255,107,107,0.75)";
    ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
  }

  // overlay message
  if(state.message) {
    ctx.fillStyle = "rgba(9,14,26,0.72)";
    roundRect(ctx, 18, 18, 360, 42, 14); ctx.fill();
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.font = "600 14px system-ui";
    ctx.fillText(state.message, 32, 45);
  }

  ctx.restore();
}

function updateTrack(){
  state.t++;

  // auto run
  if(state.phase==="stumble") {
    state.stumbleTimer--;
    state.v = Math.max(1.2, state.baseV * 0.65);
    state.wobble = 4;
    if(state.stumbleTimer <= 0) {
      state.phase = "cruise";
      state.v = state.baseV;
      state.message = "";
    }
  } else {
    state.v = state.baseV;
  }

  state.runnerX += state.v;
  state.camX = Math.max(0, state.runnerX - 180);

  // coin pickup (always)
  for(const c of state.coins) {
    if(c.taken) continue;
    if(Math.abs((state.runnerX+10) - c.x) < 18) {
      c.taken = true;
      spawnBurst(240, 180, true);
    }
  }

  // hurdle hit (visual only)
  for(const h of state.hurdles) {
    if(h.hit) continue;
    if(Math.abs((state.runnerX+10) - h.x) < 14 && state.phase==="stumble") {
      h.hit = true;
    }
  }

  // particles physics
  for(const p of state.particles) {
    p.x += p.vx;
    p.y += p.vy;
    p.vx *= 0.97;
    p.vy *= 0.97;
    p.life -= 1;
  }
  state.particles = state.particles.filter(p=>p.life>0);
  if(state.wobble>0) state.wobble *= 0.88;

  // lap finish behavior
  if(state.runnerX >= state.finishX) {
    // ë©ì´ ëë‚¨
    if(state.pendingAdvance) {
      // ì •ë‹µ/ì˜¤ë‹µ ì²˜ë¦¬ í›„ ë‹¤ìŒ ë¬¸ì œë¡œ ìë™ ì§„í–‰
      advanceQuestionAuto();
      // ë‹¤ìŒ ë¬¸ì œ ì‹œì‘: ë¬´ì¡°ê±´ ìƒˆ ë©(ì¶œë°œì„ )ì—ì„œ ë‹¤ì‹œ ë›°ê¸°
      resetToStart();
      state.pendingAdvance = false;
      state.correctResetNext = false;
    } else {
      // ì•„ì§ ë‹µì„ ì•ˆ ê³ ë¥¸ ìƒíƒœì¸ë° ê²°ìŠ¹ì„  ë„ë‹¬ â†’ ìì—°ìŠ¤ëŸ½ê²Œ ë£¨í”„
      resetToStart();
    }
  }
}

let raf;
function loop(){
  updateTrack();
  drawTrack();
  raf = requestAnimationFrame(loop);
}

/* ===== QUIZ UI ===== */
function lockChoices(flag) {
  $$("#choices .choiceBtn").forEach(b => b.disabled = flag);
}

function updateHUD() {
  const name = $("#studentName").value.trim() || "-";
  const dom = DOMAINS.find(d=>d.id===currentDomainId);
  $("#hudName").textContent = `í•™ìƒ: ${name}`;
  $("#hudDomain").textContent = `ìŠ¤í…Œì´ì§€: ${dom?.title ?? "-"}`;
  $("#hudScore").textContent = `ì ìˆ˜: ${score}`;
  $("#hudCount").textContent = `ë¬¸í•­: ${Math.min(idx+1, pool.length)}/${pool.length}`;
  $("#bar").style.width = pool.length ? `${(Math.min(idx, pool.length)/pool.length)*100}%` : "0%";
  $("#coinsPill").textContent = `ì½”ì¸: ${coins}`;
}

function setFeedback(type, html) {
  const fb = $("#feedback");
  fb.className = "feedback " + type;
  fb.style.display = "block";
  fb.innerHTML = html;
}

function buildPool() {
  const q = QUESTIONS.filter(x => x.domainId === currentDomainId);
  const picked = shuffle(q);
  pool = picked.slice(0, 5);
  if(pool.length < 5) {
    const extra = shuffle(QUESTIONS.filter(x => x.domainId !== currentDomainId));
    pool = pool.concat(extra.slice(0, 5 - pool.length));
  }
  idx = 0;
  score = 0;
  coins = 0;
  answeredLock = false;
}

function renderQuestion() {
  const fb = $("#feedback");
  fb.className = "feedback";
  fb.style.display = "none";
  fb.textContent = "";
  $("#saveBtn").disabled = true;

  if(idx >= pool.length) {
    $("#qText").textContent = "ğŸ‰ 5ë¬¸í•­ì„ ëª¨ë‘ ì™„ë£Œí–ˆì–´ìš”! ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê¸°ë¡ì„ ë‚¨ê¸°ì„¸ìš”.";
    $("#qMeta").textContent = "ì„±ì·¨ê¸°ì¤€: -";
    $("#choices").innerHTML = "";
    lockChoices(true);
    $("#saveBtn").disabled = false;
    $("#stageBadge").textContent = "DONE";
    updateHUD();
    return;
  }

  const q = pool[idx];
  $("#qText").textContent = q.question.text;
  $("#qMeta").textContent = `ì„±ì·¨ê¸°ì¤€: ${q.standardCode}`;

  const choices = $("#choices");
  choices.innerHTML = "";
  q.choices.forEach((c, i) => {
    const btn = document.createElement("button");
    btn.className = "choiceBtn";
    btn.type = "button";
    btn.textContent = `${i+1}. ${c}`;
    btn.addEventListener("click", ()=>onAnswer(i));
    choices.appendChild(btn);
  });
  lockChoices(false);
  $("#stageBadge").textContent = "RUN";
  updateHUD();
}

function onAnswer(i) {
  if(answeredLock) return;
  answeredLock = true;

  const q = pool[idx];
  const correct = (i === q.correctIndex);

  lockChoices(true);

  if(correct) {
    score += 1;
    coins += 1;
    state.message = "ì •ë‹µ! ì¶œë°œì„  ë¦¬ì…‹ í›„ ë‹¤ìŒ ë¬¸ì œ!";
    spawnBurst(240, 170, true);
    sfx("good");
    setFeedback("good", `âœ… ì •ë‹µ! <b>ê²°ìŠ¹ì„  í†µê³¼ í›„ ìë™ ë‹¤ìŒ ë¬¸ì œ</b><br><span style="color:var(--muted)">${q.answerExplanation}</span>`);
    toast("ì •ë‹µ âœ…");
    // ì •ë‹µì´ë©´ ì¦‰ì‹œ ì¶œë°œì„  ë¦¬ì…‹
    resetToStart();
  } else {
    state.phase = "stumble";
    state.stumbleTimer = 34;
    state.message = "ì˜¤ë‹µâ€¦ ë„˜ì–´ì¡Œë‹¤! ë‹¤ì‹œ ë‹¬ë ¤!";
    spawnBurst(240, 200, false);
    sfx("bad");
    setFeedback("bad", `âŒ ì˜¤ë‹µ! <b>ë„˜ì–´ì§ í›„ ê³„ì† ë‹¬ë¦¼</b><br><span style="color:var(--muted)">${q.answerExplanation}</span>`);
    toast("ì˜¤ë‹µ âŒ");
    // ì˜¤ë‹µì€ ê·¸ ìë¦¬ì—ì„œ ê³„ì† ë‹¬ë¦¼ (ë¦¬ì…‹ ì—†ìŒ)
  }

  // ê²°ìŠ¹ì„  ë„ë‹¬ ì‹œ ìë™ìœ¼ë¡œ ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°€ë„ë¡ ì˜ˆì•½
  state.pendingAdvance = true;
}

function advanceQuestionAuto() {
  idx += 1;
  answeredLock = false;
  if(idx >= pool.length) {
    renderQuestion();
    $("#saveBtn").disabled = false;
    return;
  }
  renderQuestion();
}

function startGame() {
  const name = $("#studentName").value.trim();
  if(!name) {
    alert("í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!");
    $("#studentName").focus();
    return;
  }
  currentDomainId = $("#domainSelect").value;
  buildPool();
  showView("#gameView");
  resetToStart();
  renderQuestion();
  updateHUD();
  if(raf) cancelAnimationFrame(raf);
  loop();
  toast("ìë™ ë‹¬ë¦¬ê¸° ì‹œì‘! ğŸƒ");
}

function resetGame() {
  buildPool();
  resetToStart();
  renderQuestion();
  updateHUD();
  toast("ë‹¤ì‹œ ì‹œì‘!");
}

function saveResult() {
  const name = $("#studentName").value.trim();
  if(!name) return;
  const dom = DOMAINS.find(d=>d.id===currentDomainId);
  const row = {
    time: nowStr(),
    name,
    domain: dom.title,
    range: dom.range,
    totalQ: pool.length,
    score,
    coins,
    rate: Math.round((score/pool.length)*100)
  };
  const logs = loadLogs();
  logs.push(row);
  saveLogs(logs);
  renderLogs();
  toast("ì €ì¥ ì™„ë£Œ âœ…");
}

/* ===== Setup ===== */
function initDomainSelect() {
  const sel = $("#domainSelect");
  sel.innerHTML = DOMAINS.map(d => `<option value="${d.id}">${d.title}</option>`).join("");
  sel.addEventListener("change", ()=> {
    currentDomainId = sel.value;
    const dom = DOMAINS.find(d=>d.id===currentDomainId);
    $("#domainRange").textContent = `ì„±ì·¨ê¸°ì¤€ ë²”ìœ„: ${dom.range}`;
  });
  sel.value = currentDomainId;
  $("#domainRange").textContent = `ì„±ì·¨ê¸°ì¤€ ë²”ìœ„: ${DOMAINS[0].range}`;
}

$("#startBtn").addEventListener("click", startGame);
$("#backBtn").addEventListener("click", ()=> {
  showView("#setupView");
  if(raf) cancelAnimationFrame(raf);
});
$("#resetBtn").addEventListener("click", resetGame);
$("#saveBtn").addEventListener("click", saveResult);
$("#exportBtn").addEventListener("click", exportCSV);
$("#clearBtn").addEventListener("click", clearLogs);

function init() {
  initDomainSelect();
  renderLogs();
}
init();
</script>

</body>
</html>
